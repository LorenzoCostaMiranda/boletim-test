---
documentclass: report
output: latex_fragment
---
```{r setup, include = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(ipeadatar)
library(knitr)
library(kableExtra)
library(scales)
library(formattable)
library(extrafont)
library(petgg)
library(siconfiR)

petgg::set_theme(base_family = "EB Garamond")

knitr::opts_chunk$set(
	echo = FALSE,
	eval = TRUE,
	fig.path = "fig/",
	message = FALSE,
	warning = FALSE,
	dpi = 300,
	dev = "cairo_pdf"
)

# Utils
source("ipca.R")

# Converte dataid para uma string. Exemplo: 20201 -> 1B\n2020
dateB <- function(x) {paste0(substr(x, 5, 5), "B", "\n", substr(x, 1, 4))}

# Calcula o nível preços acumulado. Exemplo ipca("2020-06) -> 1.0026
ipca_file <- readRDS("IPCA.rds")
ipca <- function(from, to = NULL) get_ipca(from, to, ipca_file)

# O Deflacionamento é feito colocando à preços de agosto de 2018
current_price <- "2020-08"

# Converte dataid para uma string no formato AAAA-MM, sendo MM o último mês do bimestre
dateStr <- function(x) {
  bimest <- c("02", "04", "06", "08", "11", "12") # bimestres do ano
  paste0(substring(x, 1, 4), "-", bimest[as.numeric(substring(x, 5, 5))])
}

# converte dataid para uma string no formato AAAA-MM, sendo MM o último mês do quadrimestre
dateQ <- function(x) {
  quadris <- c("abr", "ago", "dez")
  paste0(
    quadris[as.numeric(substring(as.character(x), 5, 5))],
    "\n",
    substring(as.character(x), 1, 4)
  )
}

# Coloca valores no formato da moeda brasileira
curBR <- function(x, to = 4, s = T) {
  formattable::currency(
    x,
    symbol = "R$",
    digits = 2L,
    big.mark = ifelse(s, ",", "."),
    decimal.mark = ifelse(s, ".", ",")
  ) %>%
  substring(., 1, to + ifelse(s, 2, 99))
}
```

```{r}
# Pegando dados do RREO/Siconfi. Para 2020 só ate o 4 bimestre. Os dados foram extraidos dia 02/11
#data_raw <- get_rreo(
#   exercicio = c(2018:2020),
#   bimestre = c(1:6), # Do 1º ao 6º bimestre
#   id_ente = c(12, 16, 13, 15, 11, 14, 17) # código do ibge de todos entes da região norte
#)

# Dados extraídos dia 10/11/2020
#rgf_norte <- get_rgf(
#   exercicio = c(2018:2020),
#   periodo = c(1:2), # quadrimestre
#   co_poder = c("E", "L", "J", "M", "D"),
#   id_ente = c(12, 16, 13, 15, 11, 14, 17)
#)
#saveRDS(rgf_norte, 'rgf_norte_2018_2020.rds')
```

```{r}
# dataid é necessário para usar lag(), o formato é AAAAB, AAAA é o ano e B o bimestre
# data no formato AAAA-MM, MM é o último mês do bimestre
rreo_norte <- read_rds("rreo_norte_2018_2020.rds") %>%
  mutate(
    dataid = paste0(exercicio, periodo) %>% as.numeric(),
    data = dateStr(dataid),
  ) %>%
  select(dataid, data, uf, anexo, coluna, cod_conta, conta, valor)

rgf_norte <- read_rds("rgf_norte_2018_2020.rds") %>%
  mutate(
    dataid = paste0(exercicio, periodo) %>% as.numeric(),
    data = dateQ(dataid)
  ) %>%
  select(dataid, data, uf, anexo, coluna, cod_conta, conta, valor)
```

# Contas Públicas Estadual

```{r}
# Receita e despesa primária do Estado. 
# Resultado primário obtidos até cada bimestre
rdp <- rreo_norte %>%
  filter(
    anexo == "RREO-Anexo 06",
    uf == "TO",
    coluna %in% c("RECEITAS REALIZADAS (a)", "DESPESAS PAGAS (a)"),
    cod_conta %in% c(
      "ReceitasPrimariasCorrentes",
      "RREO6DespesasPrimariasCorrentes"
    )
  ) %>%
  select(dataid, data, cod_conta, valor) %>%
  pivot_wider(names_from = cod_conta, values_from = valor) %>%
  rowwise() %>%
  ungroup() %>% # para usar lag()
  mutate(
    rec_real = ReceitasPrimariasCorrentes / ipca(data) * ipca(current_price),
    des_real = RREO6DespesasPrimariasCorrentes / ipca(data) * ipca(current_price),
    resul_real = rec_real - des_real,
    rec_var = rec_real - lag(rec_real, order_by = data),
    des_var = des_real - lag(des_real, order_by = data)
  )
```

O resultado primário do Estado no acumulado até o quarto bimestre de 2020 foi de cerca de R\$ 1,08 bilhões, valor 73% maior que o resultado primário acumulado no mesmo período de 2019, quando foi pouco mais de R\$ 622 milhões. No primeiro bimestre de 2020 a receita primária foi 30\% maior quando comparado com o primeiro bimestre de 2019. O resultado primário representa o esforço fiscal do governo para diminuir o estoque da dívida. A figura \ref{fig:var_receita_despesa_primaria} apresenta variação da receita e despesa primária acumulada até o bimestre em relação ao mesmo período do ano passado.

No quarto bimestre a receita primária apresentou um crescimento de 10\% no acumulado até quarto bimestre, representando um desempenho melhor que 2019, quando a crescimento da receita primária foi de pouco menos de 10\%. As despesas primária cresceu somente 2,03\%, no mesmo período de 2019 cresceu 6,48\%. O baixo crescimento da despesas primária em 2020 contribuiu para um resultado primário elevado até o quarto bimestre de 2020.

Observando as despesas por categoria no acumulado até o quarto bimestre houve aumento nos gastos com assistência social, que cresceram 132\% em relação ao quarto bimestre de 2019. Gastos da previdência social também apresentou crescimento na ordem de 16,25\%, seguido pelos gastos com saúde crescendo 12,85\% em relação a 2019.

Gastos com administração, educação e segurança pública encolheu -6,85\%, -5,69\% e -12,69\% respectivamente.

```{r var_receita_despesa_primaria, include=T}
# Variação de receita e despesa primária acumulada por bimestre
rdp %>%
  select(dataid, data, rec_real, des_real) %>%
  filter(dataid %in% c(20181:20184, 20191:20194, 20201:20204)) %>%
  mutate(
    rec_tx = (rec_real / lag(rec_real, n = 4L) -1),
    des_tx = (des_real / lag(des_real, n = 4L) -1)
  ) %>%
  pivot_longer(rec_tx:des_tx) %>%
  drop_na() %>%
  ggplot(aes(factor(dateB(dataid)), value, fill = name)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = NULL, y = NULL) +
  scale_fill_discrete(labels = c("Despesa", "Receita")) +
  scale_y_continuous(labels = scales::percent)
```


```{r echo=F}
# Despesa por categoria
dcategoria <- rreo_norte %>%
  filter(
    uf == "TO",
    anexo == "RREO-Anexo 02",
    coluna == "DESPESAS LIQUIDADAS ATÉ O BIMESTRE (d)",
    cod_conta == "RREO2TotalDespesas", # não pega despesas intra
    conta %in% c(
      "Judiciária",
      "Administração",
      "Segurança Pública",
      "Assistência Social",
      "Previdência Social",
      "Saúde",
      "Educação"
    )
  ) %>%
  select(dataid, data, conta:valor) %>%
  filter(dataid %in% c(20181:20184,20191:20194,20201:20204)) %>%
  rowwise() %>%
  mutate(
    valor_real = valor / ipca(data) * ipca(current_price)
  ) %>%
  ungroup() %>%
  mutate(
    tx_real = (valor_real / lag(valor_real, order_by = dataid, n = 28L)) -1
  )
```


```{r var_despesa_categoria, include=T}
dcategoria %>%
  filter(dataid %in% c(20194, 20204)) %>% 
  drop_na() %>%
  ggplot() +
  geom_bar(
    aes((factor(dateB(dataid))), tx_real, fill = conta), 
    stat = "identity", 
    position = "dodge",
    gap = "m"
  ) +
  labs(x = NULL, y = NULL) +
  scale_y_continuous(labels = scales::percent)
```

As despesas com pessoal em relação a receita corrente líquida \acrshort{rcl}, figura \ref{fig:desp_pessoal_rcl}, mostra parcela da \acrshort{rcl} destinada ao pagamento de despesas com pessoal no acumulado do quarto bimestre de cada ano. Até agosto as despesas com pessoal em relação a \acrshort{rcl} diminui pelo segundo ano seguido. No segundo quadrimestre de 2015 essa relação estava em 51,5\%, acima do limite máximo de 49\% para o executivo estabelecido na \acrshort{lrf}. Em 2016 ficou em 51,7\%, seguido por uma leve reducação em 2017, em 2018 as despesas em proporção a \acrshort{rcl} chegou em 55,3\%. De 2019 a 2020 a redução na relação foi de -11,74\%.

A dívida consolidada líquida (\acrshort{dcl}) do Estado em relação a \acrshort{rcl} até agosto apresentou queda. Em agosto de 2020 a relação \acrshort{dcl}/\acrshort{rcl} ficou em 44,1\%, valor abaixo do limite definido pelo Senado Federal para os Estados, de duas vezes a receita corrente líquida. Entre 2017 e 2017 a \acrshort{dcl} em proporção à \acrshort{rcl} aumentou, saindo de 30\% para 52,3\% em 2019 -- figura \ref{fig:divida_rcl}.


```{r desp_pessoal_rcl, echo=F}
# Despesa total com pessoal em relação à Receita Corrente Líquida Ajustada até o 2o quadrimestre, apenas executivo
# 2015 e 2015 a RCL não é ajustada
#despesa_pessoal_rcl <- get_rgf(year = 2015:2020, period = 2, id = 17)

despesa_pessoal_rcl <- readRDS("rgf_2015_2020_2q_to.rds")

despesa_pessoal_rcl %>% 
  mutate(
    dataid = paste0(exercicio, periodo) %>% as.numeric(),
    data = dateStr(dataid)
  ) %>% 
  filter(
    anexo == "RGF-Anexo 06",
    stringr::str_detect(coluna, "% SOBRE A RCL"),
    cod_conta == "DespesaTotalComPessoalDemonstrativoSimplificado"
  ) %>%
  select(dataid, data, valor) %>% 
  ggplot(aes(factor(dataid %>% dateQ()), valor, group = 1)) +
  geom_line() +
  scale_y_continuous(labels = function(x) paste0(x, "%"))
```


```{r divida_rcl, echo=F}
# Dívida Consolidada Líquida até o 2o quadrimestre em relação à RC
# 2020 a RCL é ajustada
divida_consolidada_liquida <- despesa_pessoal_rcl %>% 
  filter(
    anexo == "RGF-Anexo 02",
    coluna == "Até o 2º Quadrimestre",
    cod_conta == "DividaConsolidadaLiquida"
  )
  
receita_corrente_liquida <- despesa_pessoal_rcl %>% 
  filter(
    anexo == "RGF-Anexo 02",
    coluna == "Até o 2º Quadrimestre",
    cod_conta == "RGF2ReceitaCorrenteLiquida"
  )
  
left_join(
  divida_consolidada_liquida,
  receita_corrente_liquida,
  by = "exercicio"
) %>% 
  select(exercicio, periodo.x, valor.x, valor.y) %>% 
  rename(dcl = valor.x, rcl = valor.y, periodo = periodo.x) %>% 
  mutate(
    dataid = paste0(exercicio, periodo) %>% as.numeric(),
    divida_rcl = dcl / rcl
  ) %>% 
  ggplot(aes(dataid %>% dateQ() %>% factor(), divida_rcl, group = 1)) +
  geom_line() +
  scale_y_continuous(labels = scales::percent)
```


```{r echo=F, include=FALSE}
# Balanço Orçamentário - Anexo 01
# DESPESAS EMPENHADAS ATÉ O BIMESTRE (f)
# bo <- rreo_norte %>%
#   filter(
#     dataid %in% c(20181:20204),
#     anexo == "RREO-Anexo 01",
#     coluna %in% c("No Bimestre (b)", "DESPESAS LIQUIDADAS NO BIMESTRE")
#   ) %>%
#   select(!c(coluna,anexo))
```

O capacidade de pagamento (\acrshort{capag}) traz informações a cerca da situação fiscal do Estados e Munícipois. A nota é utlizada para Estados contrair empréstimos com garantia do Governo Federal. A nota atribuida a cada Estado (A, B ou C) ou Município é derivada de três indicadores: endividamento, poupança corrente e liquidez. Em 2020 apenas o Espírito Santo obteve nota A. O Tocantins ficou com nota C por três anos seguidos. Notas A e B permite que o Estado receba garantia da União para solicitar novos empréstimos.

Dos Estados da região norte, os que apresentaram pior nota foi Roraima e Tocantins. Rondônia aparece como o Estado com melhor evolução, Saiu de B para A entre 2019-2020, a queda no endividamento de 65,41% para 57,6% e a redução na relação obrigações financeiras/disponibilidade de caixa e a queda na sua liquidez para 19,1% garantiu nota A em todos os indicadores.

O Tocantins apesar de manter a mesma nota, teve pioras em todos os indicadores: endividamento, poupança corrente e liquidez. O endividamento que representa a dívida consolidada bruta em relação a receita corrente líquida aumentou de 46,35% para 67,6%, a poupança corrente que corresponde a relação despesas correntes e receita correntes ajustadas também apresentou uma pequena piora, aumentou de 94,56% para 95,9%. Um índice de poupança corrente menor garante nota maior, pois melhor será a capacidade da receita corrente de financiar investimentos. O último indicador, liquidez, foi de 577,5\% em 2020, ante 539,40\% em 2019.

para obter nota A, o Estado ou Município deve ter um índice menor que 100%, o que significa que sua disponibilidade em caixa é maior que suas obrigações financeiras. O Tocantins tem um índice de 577,5%, em 2019 era 539,40%.

De todos os indicadores do Estado, endividamento e poupança corrente estão em melhor situação, pois estão mais próximo do limite para receber uma melhor nota. Para conseguir uma nota A no índice de endividamento o Estado deve conservá-lo abaixo de 60%, atualmente está com 67,6%. No índice de poupança corrente, para garantir uma nota B o índice deve maior ou igual a 90% e menor que 95%. Para uma nota A, basta que seja menor que 90%, atualmente está em 95,9%, bem próximo de 95%. O índice de liquidez é uma situação mais delicada para o Estado, ele tem maior peso na nota final. Para obter uma nota B é necessário obter A no índice de liquidez e nota acima de C (B ou A) na poupança, independente da nota do endividamento.

```{r echo = F, include=T}

capag_2019 <- readxl::read_excel(
  "planilhas/Tabelas_Boletim_Financas_2019.xlsx",
  sheet = "Tabela 19",
  skip = 1,
  col_types = "guess"
) %>% select(1:8) %>%
	mutate(ano = 2019)

capag_2020 <- readxl::read_excel(
  "planilhas/Tabelas_Boletim_Financas_2020.xlsx",
  sheet = "Tabela_25",
  skip = 1,
  col_types = "guess"
) %>%
  select(1:8) %>%
  mutate(ano = 2020)

# rearranjando as colunas pra criar a tabela
tibble(
  UF = capag_2020$UF,
  DC_2019 = capag_2019$Nota...4,
  DC_2020 = capag_2020$Nota...4,
  PC_2019 = capag_2019$Nota...6,
  PC_2020 = capag_2020$Nota...6,
  IL_2019 = capag_2019$Nota...8,
  IL_2020 = capag_2020$Nota...8
) %>%
  filter(UF %in% c("AC", "AM", "AP", "PA", "RO", "RR", "TO")) %>%
  kable(.,
  	caption = "Nota da capacidade de pagamento",
    booktabs = T,
    align = "lcccccc",
    col.names = c("UF", rep(c("2019","2020"),3))
  ) %>%
  kable_styling(full_width = T) %>%
  add_header_above(c(" " = 1, "Endividamento" = 2, "Poupança\nCorrente" = 2, "Liquidez" = 2))

```